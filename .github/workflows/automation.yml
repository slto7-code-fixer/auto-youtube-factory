name: Auto YouTube Factory

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # الخطوة 1: سحب الكود
      - name: Checkout code
        uses: actions/checkout@v3

      # الخطوة 2: تثبيت Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # الخطوة 3: عرض الملفات للتأكد
      - name: Show project files
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Files in project ==="
          ls -la
          echo "=== Files in agents/ ==="
          ls -la agents/

      # الخطوة 4: تثبيت المتطلبات
      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found"
          fi

      # الخطوة 5: إنشاء ملف client_secret.json
      - name: Create client_secret.json
        env:
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          echo "=== Creating client_secret.json ==="
          if [ -n "$GOOGLE_CLIENT_SECRET" ]; then
            echo "$GOOGLE_CLIENT_SECRET" > client_secret.json
            echo "✅ File created successfully"
            echo "File size: $(wc -c < client_secret.json) bytes"
          else
            echo "❌ ERROR: GOOGLE_CLIENT_SECRET is empty!"
            exit 1
          fi

      # الخطوة 6: اختبار استيراد agents
      - name: Test Python imports
        run: |
          echo "=== Testing Python imports ==="
          cd /home/runner/work/auto-youtube-factory/auto-youtube-factory
          python -c "
import sys
sys.path.insert(0, '.')
print('Python path:', sys.path[:3])
try:
    import agents
    print('✅ Successfully imported agents')
    print('Agents module location:', agents.__file__)
except Exception as e:
    print(f'❌ Error importing agents: {e}')
    import traceback
    traceback.print_exc()
"

      # الخطوة 7: تشغيل supervisor
      - name: Run supervisor
        env:
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          echo "=== Running supervisor ==="
          
          # الانتقال إلى الدليل الصحيح
          cd /home/runner/work/auto-youtube-factory/auto-youtube-factory
          
          # إضافة المسار الحالي إلى PYTHONPATH
          export PYTHONPATH=/home/runner/work/auto-youtube-factory/auto-youtube-factory:$PYTHONPATH
          
          # تشغيل supervisor مع معالجة الأخطاء
          python -c "
import sys
import traceback

try:
    # أضف المسار الحالي أولاً
    sys.path.insert(0, '/home/runner/work/auto-youtube-factory/auto-youtube-factory')
    
    print('Python path:', sys.path[:3])
    print('---')
    
    # استيراد وتشغيل supervisor
    from agents import supervisor
    
    # إذا كان هناك main function
    if hasattr(supervisor, 'main'):
        print('Calling supervisor.main()...')
        supervisor.main()
    else:
        print('No main() function found in supervisor')
        print('Trying to execute module directly...')
        import agents.supervisor
        
except Exception as e:
    print(f'❌ ERROR: {type(e).__name__}: {e}')
    print('--- Full traceback:')
    traceback.print_exc()
    sys.exit(1)
"

      # الخطوة 8: إذا فشل supervisor، جرب طريقة بديلة
      - name: Alternative run method
        if: failure()
        run: |
          echo "=== Trying alternative method ==="
          cd /home/runner/work/auto-youtube-factory/auto-youtube-factory
          
          # جرب تشغيل الملف مباشرة
          python agents/supervisor.py || echo "Script exited with error"
          
          # إذا كان هناك خطأ، اعرض آخر 50 سطراً من أي ملف log
          if [ -f "supervisor.log" ]; then
            echo "=== supervisor.log content ==="
            tail -50 supervisor.log
          fi
