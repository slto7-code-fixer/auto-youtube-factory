name: Auto YouTube Factory

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # تثبيت الحزمة الحالية أولاً
          pip install -e . || echo "Could not install as package, continuing..."
          # ثم تثبيت المتطلبات الأخرى
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Debug - Show Python path
        run: |
          echo "=== Python Path ==="
          python -c "import sys; print('\n'.join(sys.path))"
          
      - name: Run supervisor script
        env:
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          PYTHONPATH: /home/runner/work/auto-youtube-factory/auto-youtube-factory
        run: |
          echo "=== Running supervisor script ==="
          
          # 1. إنشاء client_secret.json
          if [ -n "$GOOGLE_CLIENT_SECRET" ]; then
            echo "Creating client_secret.json..."
            echo "$GOOGLE_CLIENT_SECRET" > client_secret.json
          else
            echo "ERROR: GOOGLE_CLIENT_SECRET is not set!"
            exit 1
          fi
          
          # 2. تشغيل السكريبت مع debug
          echo "Starting supervisor..."
          set -x  # لعرض الأوامر أثناء التنفيذ
          
          # الطريقة المضمونة: استخدام python -m من الدليل الجذر
          cd /home/runner/work/auto-youtube-factory/auto-youtube-factory
          python -c "
import sys
print('Python version:', sys.version)
print('Current dir:', sys.path[0])
print('Has agents?', 'agents' in sys.modules)
"
          
          python -m agents.supervisor
          
          EXIT_CODE=$?
          echo "Supervisor exited with code: $EXIT_CODE"
          exit $EXIT_CODE
